<!DOCTYPE html>
<html lang="ko">
<title>도메인 관리</title>

<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link rel="stylesheet" href="tree_fontello/css/fontello.css">
  <style>

  </style>
  <script>
    $(function () {
      $("#subNav").load("../subNav.html");
      $("#js").load("../js.html");
      $("#headerTop").load("../headerTop.html");
    });
  </script>
</head>




<body>

  <!-- 메뉴 -->
  <div id="subNav"></div>
  <div id="js"></div>
  <div id="headerTop"></div>
  <!-- 메뉴 End-->

  <!-- 내용 -->
 <!-- 본문  -->
 <div class="main-panel">
  <!-- Page content -->
  <div class="container-fluid">
    <div class="card mb-4">
        <!-- Card header -->
        <!-- 서버환경 정보 -->
        <div class="card">
            <!-- Card header -->
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h3 class="mb-0">핸들러 설정 상세</h3>
                    </div>
                    <div class="col text-right">
                        <a href="#" class="btn btn-sm btn-primary btn-round btn-icon" >
                            <span class="btn-inner--icon"><i class="fas fa-save"></i></span>
                            <span class="btn-inner--text">저장</span>
                        </a>
                        <a href="env_handlerList.html" class="btn btn-sm btn-default btn-round btn-icon">
                            <span class="btn-inner--icon"><i class="fas fa-list"></i></span>
                            <span class="btn-inner--text">목록</span>
                        </a>
                    </div>
                </div>
            </div>
            <!-- card-body -->
            <div class="card-body">
                <form>

                    <div class="form-group row">
                        <label for="openclickPath"
                            class="col-md-2 col-form-label form-control-label ">핸들러 이름</label>
                        <div class="col-md-10">
                            <input class="form-control " type="text"
                                value="BRANDTALKhttp://dev.mnwise.com:8084/images/common/content_dot_02.gif" id="openclickPath">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="openclickPath"
                            class="col-md-2 col-form-label form-control-label ">핸들러 설명</label>
                        <div class="col-md-10">
                            <input class="form-control " type="text"
                                value="BRANDTALK desc" id="openclickPath">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="openclickPath"
                            class="col-md-2 col-form-label form-control-label ">서비스타입</label>
                        <div class="col-md-10">
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline1" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline1">캠페인  </label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline2" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline2">이케어 </label>
                              </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="openclickPath"
                            class="col-md-2 col-form-label form-control-label ">A/B테스트</label>
                        <div class="col-md-10">
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label">사용</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline2" class="custom-control-input" disabled>
                                <label class="custom-control-label">미사용 </label>
                              </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="openclickPath"
                            class="col-md-2 col-form-label form-control-label ">채널</label>
                        <div class="col-md-10">
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline1" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline1">EMAIL</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline2" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline2">SMS</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline1" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline1">LMS/MMS</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline2" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline2">알림톡</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline1" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline1">친구톡</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline2" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline2">브랜드톡</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline1" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline1">PUSH</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline2" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline2">FAX</label>
                              </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="openclickPath"
                            class="col-md-2 col-form-label form-control-label ">타입</label>
                        <div class="col-md-10">
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline1" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline1">GROOVY</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="customRadioInline2" name="customRadioInline1" class="custom-control-input" disabled>
                                <label class="custom-control-label" for="customRadioInline2">SCRIPT </label>
                              </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <textarea class="form-control" id="template" rows="30">//***************************************************/
                // 브랜드톡 캠페인 핸들러
                //***************************************************/
                import java.util.Date;
                import java.text.SimpleDateFormat;
                
                import com.mnwise.ASE.agent.dbagent.DBAgent
                import com.mnwise.ASE.agent.dbagent.DBConnection
                import com.mnwise.ASE.agent.dbagent.DBPreparedStatement
                import com.mnwise.ASE.agent.dbagent.DBRecordSet
                import com.mnwise.ASE.agent.kakaoagent.TalkAgent;
                import com.mnwise.ASE.agent.kakaoagent.TalkData;
                import com.mnwise.ASE.agent.util.ExceptionLogger;
                import com.mnwise.ASE.agent.util.TextReader;
                import com.mnwise.ASE.pscript.Message;
                import com.mnwise.ASE.pscript.ScrProperties;
                import com.mnwise.common.util.DateUtil;
                import com.mnwise.common.util.LoggerAid;
                import com.mnwise.common.util.Util;
                import com.mnwise.common.util.StringUtil;
                import com.mnwise.mts.Config;
                import com.mnwise.ASE.agent.util.AseUtil;
                
                boolean useResend = Config.getLstResendUse();
                boolean isSendMode = "N".equals(context.get("_PREVIEW_YN"));
                
                TalkAgent talkAgent = new TalkAgent(context)
                
                ExceptionLogger exlogger = new ExceptionLogger(context)
                
                Date dt = new Date()
                DateUtil term = new DateUtil()
                SimpleDateFormat time = new SimpleDateFormat("yyyyMMddHHmmss")
                addterm = term.addTime(dt,"7","00","00","00")
                context.put("_START_DATE", time.format(dt))
                context.put("_END_DATE", time.format(addterm))
                
                _KEY_FIELD_SEQ = context.getInt("_KEY_FIELD_SEQ")
                _NAME_FIELD_SEQ = context.getInt("_NAME_FIELD_SEQ")
                _MMS_FIELD_SEQ = context.getInt("_MMS_FIELD_SEQ")
                
                TextReader target = new TextReader(context)
                
                
                //DB커넥션 생성
                DBAgent dbagent = new DBAgent(context.get("_jdbc.driver"))
                DBConnection conn = dbagent.getConnection(context.get("_jdbc.url"),context.get("_jdbc.user"),context.get("_jdbc.password"))
                DBRecordSet rs = null
                
                //변수 정의
                String errMsg = null;
                TalkData ad = null;
                int serviceNo = Integer.parseInt(context.get("_CAMPAIGN_NO"));
                String sResultSeq = context.get("_RESULT_SEQ");
                String tmplCd = context.get("_KAKAO_TMPL_CD");
                String msgType = context.get("_KAKAO_MESSAGE_TYPE");
                String contentType = context.get("_KAKAO_CONTENT_TYPE");
                String senderKey = context.get("_KAKAO_SENDER_KEY");
                Message message = new Message(context);
                message.prepareGroovyTemplate()
                
                while (target.next()) {
                    try {
                        // 본문에서도 수신대상자의 정보를 사용할수 있도록 context객체에 담기
                        context.put("record", target.getRecord())
                        ad = new TalkData();
                        ad.setPhoneNo(target.getString(_MMS_FIELD_SEQ))
                        ad.setUserName(target.getString(_NAME_FIELD_SEQ));
                        ad.setTmplCd(tmplCd)
                        ad.setSenderKey(senderKey)
                        ad.setMessageType(msgType);
                        ad.setContentType(contentType)
                        ad.setReqDeptId(context.get("_REQ_DEPT_ID"))
                        ad.setReqUserId(context.get("_REQ_USER_ID"))
                        ad.setReqDtm(time.format(new Date()))
                        ad.setServiceType(context.get("_CLIENT"));
                        ad.setServiceNo(serviceNo);
                        ad.setResultSeq(Long.parseLong(sResultSeq));
                        ad.setSndMsg(message.execGroovyTemplate());
                        ad.setKakaoButton(context.get("_KAKAO_BUTTONS"))
                        if(useResend) {
                            ad.setUserId(target.getString(_KEY_FIELD_SEQ))
                        }
                
                        talkAgent.send(ad)
                    } catch(Exception e) {
                        context.put("_EXCEPTION", e);
                        exlogger.write(target.toString(), e)
                        errMsg = LoggerAid.onlyOneLine(e).substring(0, 200)
                        if(isSendMode) {
                            try {
                                exlogger.insertSendLog(target, target.getString(_MMS_FIELD_SEQ), target.getString(_KEY_FIELD_SEQ), target.getString("_NAME_FIELD_SEQ"), errMsg, target.getString(_KEY_FIELD_SEQ), context.get("_REQ_DEPT_ID"))
                            } catch(Exception sub_e){
                                exlogger.write(ad.toString(), sub_e)
                            }
                        }
                    }
                }   //  end While
                AseUtil.closeQuietly(conn);
                exlogger.close()
                target.close()
                talkAgent.close()
                </textarea>
                    </div>
                </form>
            </div> <!-- e.Card body -->
        </div>
    </div>
    <!--e.container-fluid-->
</div> <!-- e.page content -->
</div>
  <!--내용-->



</html>